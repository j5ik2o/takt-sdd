name: BugBot ‚Üí GitHub Issue

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: read

jobs:
  create-issue:
    # BugBot „ÅÆ„Ç≥„É°„É≥„Éà„ÅÆ„ÅøÂØæË±°
    # issue_comment „ÅØ PR ‰∏ä„ÅÆ„Ç≥„É°„É≥„Éà„ÅÆ„ÅøÔºàÈÄöÂ∏∏ Issue „ÅØÈô§Â§ñÔºâ
    if: |
      github.event.comment.user.login == 'cursor[bot]' &&
      (
        github.event_name == 'pull_request_review_comment' ||
        github.event.issue.pull_request != null
      )
    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR URL and number
        id: pr
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            echo "url=${{ github.event.pull_request.html_url }}" >> "$GITHUB_OUTPUT"
            echo "number=${{ github.event.pull_request.number }}"  >> "$GITHUB_OUTPUT"
          else
            echo "url=${{ github.event.issue.html_url }}"  >> "$GITHUB_OUTPUT"
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract issue title from BugBot comment
        id: title
        env:
          BODY: ${{ github.event.comment.body }}
        run: |
          # Á©∫Ë°å„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶ÊúÄÂàù„ÅÆË°å„ÇíÂèñÂæóÔºàÊúÄÂ§ß80ÊñáÂ≠óÔºâ
          title=$(printf '%s' "$BODY" | grep -m1 -v '^[[:space:]]*$' | sed 's/^#*[[:space:]]*//' | cut -c1-80)
          # „Çø„Ç§„Éà„É´„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§
          echo "title=${title:-BugBot detected an issue}" >> "$GITHUB_OUTPUT"

      - name: Ensure "bug" label exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create bug \
            --repo "${{ github.repository }}" \
            --color d73a4a \
            --description "Something isn't working" \
            2>/dev/null || true

      - name: Build issue body
        env:
          PR_URL: ${{ steps.pr.outputs.url }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
        run: |
          # --body-file „Çí‰Ωø„ÅÑ„Ç≥„Éû„É≥„Éâ„Ç§„É≥„Ç∏„Çß„ÇØ„Ç∑„Éß„É≥„ÇíÈò≤„Åê
          {
            echo "> **BugBot „Åå PR #${PR_NUMBER} „ÅßÊ§úÂá∫„Åó„Åü„Éê„Ç∞**"
            echo "> ${PR_URL}"
            echo ""
            echo "---"
            echo ""
            printf '%s\n' "${COMMENT_BODY}"
            echo ""
            echo "---"
            echo ""
            echo "**ÂÖÉ„Ç≥„É°„É≥„Éà**: ${COMMENT_URL}"
          } > /tmp/issue-body.md

      - name: Create GitHub Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUG_TITLE: ${{ steps.title.outputs.title }}
        run: |
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "üêõ [BugBot] ${BUG_TITLE}" \
            --body-file /tmp/issue-body.md \
            --label "bug"
