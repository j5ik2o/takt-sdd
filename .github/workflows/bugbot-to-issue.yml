name: BugBot ‚Üí GitHub Issue

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: read

jobs:
  create-issue:
    # BugBot „ÅÆ„Ç≥„É°„É≥„Éà„ÅÆ„ÅøÂØæË±°
    if: github.event.comment.user.login == 'cursor-bot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Resolve PR URL and number
        id: pr
        env:
          BODY: ${{ github.event.comment.body }}
        run: |
          # pull_request_review_comment „ÅÆÂ†¥Âêà
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            echo "url=${{ github.event.pull_request.html_url }}" >> "$GITHUB_OUTPUT"
            echo "number=${{ github.event.pull_request.number }}"  >> "$GITHUB_OUTPUT"
          else
            # issue_comment „ÅÆÂ†¥ÂêàÔºàPR„Å´„ÇÇ issue_comment „Ç§„Éô„É≥„Éà„ÅåÊù•„ÇãÔºâ
            echo "url=${{ github.event.issue.html_url }}"   >> "$GITHUB_OUTPUT"
            echo "number=${{ github.event.issue.number }}"  >> "$GITHUB_OUTPUT"
          fi

      - name: Extract issue title from BugBot comment
        id: title
        env:
          BODY: ${{ github.event.comment.body }}
        run: |
          # „Ç≥„É°„É≥„Éà1Ë°åÁõÆ„Çí title „Å´‰Ωø„ÅÜÔºàÁ©∫Ë°å„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
          title=$(echo "$BODY" | grep -m1 -v '^[[:space:]]*$' | sed 's/^#*[[:space:]]*//' | cut -c1-80)
          echo "title=${title}" >> "$GITHUB_OUTPUT"

      - name: Ensure "bug" label exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create bug \
            --repo "${{ github.repository }}" \
            --color d73a4a \
            --description "Something isn't working" \
            2>/dev/null || true

      - name: Create GitHub Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.pr.outputs.url }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          BUG_TITLE: ${{ steps.title.outputs.title }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_URL: ${{ github.event.comment.html_url }}
        run: |
          gh issue create \
            --repo "${{ github.repository }}" \
            --title "üêõ [BugBot] ${BUG_TITLE}" \
            --body "$(cat <<EOF
          > **BugBot „Åå PR #${PR_NUMBER} „ÅßÊ§úÂá∫„Åó„Åü„Éê„Ç∞**
          > ${PR_URL}

          ---

          ${COMMENT_BODY}

          ---

          **ÂÖÉ„Ç≥„É°„É≥„Éà**: ${COMMENT_URL}
          EOF
          )" \
            --label "bug"
