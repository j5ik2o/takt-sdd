name: opsx-apply
description: OpenSpec Apply - Implement tasks from a change with batch execution and review
piece_config:
  provider_options:
    codex:
      network_access: true
    opencode:
      network_access: true
max_movements: 50
initial_movement: plan

# --- Custom Facet Section Map ---
instructions:
  plan: ../facets/instructions/opsx-apply-plan.md
  implement: ../facets/instructions/opsx-apply-execute.md

report_formats:
  opsx-apply-summary: ../facets/output-contracts/opsx-apply-summary.md

# --- Loop Monitors ---
loop_monitors:
  - cycle:
      - plan
      - implement
    threshold: 5
    judge:
      persona: supervisor
      instruction_template: |
        The plan-implement batch loop has repeated {cycle_count} times.

        **Reports to reference:**
        - Batch plan: {report:00-plan.md}
        - Implementation scope: {report:coder-scope.md}

        **Judgment criteria:**
        - Are new tasks being completed in each cycle?
        - Is the task checkbox count increasing?
      rules:
        - condition: Healthy (progress being made)
          next: plan
        - condition: Unproductive (no improvement)
          next: ai_review

  - cycle:
      - ai_review
      - ai_fix
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        The ai_review-ai_fix loop has repeated {cycle_count} times.

        **Reports to reference:**
        - AI review results: {report:04-ai-review.md}

        **Judgment criteria:**
        - Are new issues being found and fixed in each cycle?
        - Are the same issues being raised repeatedly?
      rules:
        - condition: Healthy (progress being made)
          next: ai_review
        - condition: Unproductive (no improvement)
          next: supervise

# --- Movement Definitions ---
movements:
  # ===== Scheduler: Analyze task flow and determine batch =====
  - name: plan
    edit: false
    persona: planner
    knowledge: architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
      - WebSearch
      - WebFetch
    instruction: plan
    output_contracts:
      report:
        - name: 00-plan.md
          format: plan
    rules:
      - condition: Incomplete tasks exist
        next: implement
      - condition: All tasks complete
        next: ai_review
      - condition: tasks.md does not exist or is empty
        next: ABORT
        appendix: |
          tasks.md not found or empty.
          Run opsx-propose first to generate tasks.
      - condition: Requirements unclear, insufficient information
        next: ABORT
        appendix: |
          Clarification needed:
          - {question1}
          - {question2}

  # ===== Sequential Implementation: Only implement batch tasks =====
  - name: implement
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    session: refresh
    knowledge:
      - backend
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    instruction: implement
    output_contracts:
      report:
        - name: coder-scope.md
          format: coder-scope
        - name: coder-decisions.md
          format: coder-decisions
    rules:
      - condition: Batch implementation complete
        next: plan
      - condition: Problem occurred during implementation, plan revision needed
        next: plan
      - condition: Unable to determine, insufficient information
        next: plan

  # ===== AI Review =====
  - name: ai_review
    edit: false
    persona: ai-antipattern-reviewer
    policy:
      - review
      - ai-antipattern
    allowed_tools:
      - Read
      - Glob
      - Grep
      - WebSearch
      - WebFetch
    instruction: ai-review
    output_contracts:
      report:
        - name: 04-ai-review.md
          format: ai-review
    rules:
      - condition: No AI-specific issues found
        next: supervise
      - condition: AI-specific issues found
        next: ai_fix

  # ===== AI Issue Fix =====
  - name: ai_fix
    edit: true
    persona: coder
    policy:
      - coding
      - testing
    session: refresh
    knowledge:
      - backend
      - architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Edit
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    pass_previous_response: false
    instruction: ai-fix
    rules:
      - condition: AI issue fix complete
        next: ai_review
      - condition: Fix not needed (target file/spec verified)
        next: supervise
      - condition: Unable to determine, insufficient information
        next: supervise

  # ===== Final Validation =====
  - name: supervise
    edit: false
    persona: supervisor
    policy: review
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Bash
      - WebSearch
      - WebFetch
    pass_previous_response: false
    instruction: supervise
    output_contracts:
      report:
        - name: supervisor-validation.md
          format: supervisor-validation
        - name: apply-summary.md
          format: opsx-apply-summary
          use_judge: false
    rules:
      - condition: All clear
        next: COMPLETE
      - condition: Requirements not met, test failures, build errors
        next: plan
