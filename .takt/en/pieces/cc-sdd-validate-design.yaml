name: cc-sdd-validate-design
description: SDD (Optional) - Design quality review with GO/NO-GO decision. On NO-GO, auto-fix and re-validate loop
piece_config:
  provider_options:
    codex:
      network_access: true
    opencode:
      network_access: true
max_movements: 15
initial_movement: validate-design

policies:
  cc-sdd-design-review: ../facets/policies/cc-sdd-design-review.md
  cc-sdd-design: ../facets/policies/cc-sdd-design.md

instructions:
  validate-design: ../facets/instructions/cc-sdd-validate-design.md
  fix-design: ../facets/instructions/cc-sdd-fix-design.md

knowledge:
  design-discovery: ../facets/knowledge/design-discovery.md

report_formats:
  cc-sdd-design-review: ../facets/output-contracts/cc-sdd-design-review.md
  cc-sdd-design: ../facets/output-contracts/cc-sdd-design.md

loop_monitors:
  - cycle:
      - validate-design
      - fix-design
    threshold: 3
    judge:
      persona: supervisor
      instruction_template: |
        The design review-fix cycle has repeated {cycle_count} times.

        **Reports to reference:**
        - Design review: {report:design-review.md}

        **Evaluation criteria:**
        - Are new issues being discovered and fixed in each cycle?
        - Are the same findings being repeated?
      rules:
        - condition: Healthy (progress being made)
          next: validate-design
        - condition: Unproductive (no improvement)
          next: ABORT

movements:
  - name: validate-design
    edit: false
    persona: architecture-reviewer
    policy: cc-sdd-design-review
    knowledge: architecture
    allowed_tools:
      - Read
      - Glob
      - Grep
    instruction: validate-design
    output_contracts:
      report:
        - name: design-review.md
          format: cc-sdd-design-review
    rules:
      - condition: GO (design quality sufficient)
        next: COMPLETE
      - condition: NO-GO (critical issues found)
        next: fix-design
      - condition: Design not found
        next: ABORT

  - name: fix-design
    edit: true
    persona: planner
    policy: cc-sdd-design
    knowledge:
      - architecture
      - design-discovery
    allowed_tools:
      - Read
      - Glob
      - Grep
      - Write
      - Bash
      - WebSearch
      - WebFetch
    required_permission_mode: edit
    pass_previous_response: false
    instruction: fix-design
    output_contracts:
      report:
        - name: design.md
          format: cc-sdd-design
    rules:
      - condition: Fixes complete
        next: validate-design
      - condition: Unable to fix (fundamental design change required)
        next: ABORT
        appendix: |
          Reason unable to fix:
          - {reason}
