# qgrep ギャップ分析

## サマリー
- 対象 feature は `qgrep` で、要件は `.kiro/specs/qgrep/requirements.md` に存在することを確認済み。
- 現状コードベースには Rust 実装（`Cargo.toml`, `src/`, `tests/`）が存在せず、要件 1〜9 の実装資産は実質 `Missing`。
- 再利用可能な資産は要件文書・既存設計案（`design.md`）・調査メモ（`research.md`）・実行スクリプトであり、実装そのものは新規作成が前提。
- 主要課題は、並列検索時の決定的な出力順序（要件6.3/6.4）、エラー優先の終了コード（要件8.4）、コンテキスト境界（要件5.7/5.8）の取り扱い。
- 推奨は **C: ハイブリッド**（新規実装 + 既存設計資産の流用）で、設計フェーズで未確定仕様を先に固定してから実装に入る。

## 要件-資産マッピング

### 技術的ニーズ（実装に必要）
- Rust プロジェクト初期化（`cargo init`）と CLI エントリーポイント構築
- 引数解析（`clap`）、検索方式切替（`regex` / 固定文字列）
- 再帰探索と `.gitignore` 適用（`ignore`）
- フィルタ判定（パス include/exclude, 拡張子 include/exclude）
- ファイルごとの検索実行とコンテキスト抽出
- 並列実行（`rayon`）と後段ソート（`path ASC`, `line_number ASC`）
- 出力整形（テキスト / JSON Lines）
- GNU grep 互換終了コードポリシー
- ユニットテスト・統合テストの両系統

### マッピング表
| 要件 | 既存資産 | ギャップ | メモ |
|---|---|---|---|
| 1. 検索方式の選択 | `requirements.md`, `design.md` の仕様記述のみ | **Missing** | 実コードなし。`regex` コンパイル失敗を終了コード `2` に接続する実装が必要。 |
| 2. 再帰検索と `.gitignore` 尊重 | 仕様記述のみ | **Missing** | 走査層の実装なし。`.gitignore` 解決基準は探索起点に依存するため実装時に固定が必要。 |
| 3. パス/拡張子フィルタ | 仕様記述のみ | **Missing / Unknown** | 判定ロジックは未実装。パスフィルタ文法（glob/regex/完全一致）が未確定。 |
| 4. 行番号・ファイル名付き出力 | 仕様記述のみ | **Missing** | 出力フォーマッタ未実装。`path:line:content` 形式を保証する責務が必要。 |
| 5. 前後コンテキスト表示 | 仕様記述のみ | **Missing / Constraint** | 境界行（先頭/末尾）と `-A/-B/-C` 合成時の重複抑止方針を明確化する必要。 |
| 6. 並列検索 | 仕様記述のみ | **Missing / Constraint** | `rayon` 利用は必須。並列化後に決定順序へ正規化しないと要件違反。 |
| 7. JSON 出力 | 仕様記述のみ | **Missing / Constraint** | JSON Lines 専用出力とテキスト出力排他が必要。各行の妥当 JSON 保証が必須。 |
| 8. GNU grep 互換終了コード | 仕様記述のみ | **Missing / Constraint** | マッチ有無よりエラー優先（8.4）を一元判定するポリシー層が必要。 |
| 9. プロジェクト初期化とテスト | `test.sh` などの実行ラッパー | **Missing** | Rust プロジェクト本体・ユニット/統合テストが未作成。`cargo test` 実行対象も未整備。 |

## 実装アプローチ
| アプローチ | 方式 | メリット | デメリット | 適合度 |
|---|---|---|---|---|
| A: 既存拡張 | 既存コードを段階的に拡張 | 既存資産を維持しやすい | Rust 実装が存在しないため拡張対象がほぼない。実質的に成立しにくい | 低 |
| B: 新規作成 | `cargo init` 後に全機能を新規実装 | 構造をゼロから最適化しやすい。責務分離を設計どおりに作れる | 実装量が一気に増える。仕様の曖昧点を実装中に吸収する必要がある | 中 |
| C: ハイブリッド | Rust 実装は新規作成しつつ、`design.md` の責務分割・テスト観点を流用 | 新規実装の自由度を維持しつつ、設計再検討コストを削減できる | 設計資産と実装実態の差分管理が必要 | 高（推奨） |

## 工数・リスク
- 工数: **M (3-7日)**。理由: 実装は新規だが、要件は具体的で使用技術（`clap`, `regex`, `ignore`, `rayon`, `serde_json`）が成熟しているため。
- リスク: **Medium**。理由: フィルタ文法・バイナリファイル扱いなどの未確定仕様と、並列時の決定順序/終了コード優先規則の実装ミス余地があるため。

## 設計フェーズへの推奨事項
- 推奨アプローチは **C: ハイブリッド**。`design.md` の責務境界（探索・検索・整列・出力・終了コード判定）を採用し、実装を新規構築する。
- 要調査項目 1: パス include/exclude のマッチング文法（glob か regex か）を明示する。
- 要調査項目 2: バイナリ/非UTF-8ファイルの既定動作（スキップ/エラー/バイト列処理）を明示する。
- 要調査項目 3: 近接マッチ時のコンテキスト重複行の扱い（重複許容/統合）を明示する。
- 要調査項目 4: 実行エラーの収集単位（ファイル単位）と `stderr` 出力方針を明示し、終了コード `2` 判定条件を固定する。
- 要調査項目 5: テスト方針として、ユニットは純粋関数中心、統合は CLI 振る舞い（出力形式・終了コード）中心に分離する。
