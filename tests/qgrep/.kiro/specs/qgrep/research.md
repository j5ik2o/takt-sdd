# qgrep 発見ログ

## 1. 調査対象と前提
- 対象 feature: `qgrep`
- 要件ソース: `.kiro/specs/qgrep/requirements.md`
- 追加ステアリング: `.kiro/steering/` は存在しないため追加制約なし
- 実行ポリシー確認: `.takt/runs/20260219-171412-qgrep/context/policy/generate-design.1.20260219T171412Z.md`
- 設計知識確認: `.takt/runs/20260219-171412-qgrep/context/knowledge/generate-design.1.20260219T171412Z.md`

## 2. 既存コードベース調査
### 2.1 現状のファイル構成
調査時点で実装コードは未作成で、以下のみ存在する。
- `test-design.sh`
- `test-requirement.sh`
- `run-takt.sh`
- `.kiro/specs/qgrep/requirements.md`

`Cargo.toml`、`src/`、`tests/` は未存在であり、要件9.1（`cargo init` 構成）から新規作成が必要。

### 2.2 既存フローと統合ポイント
- `test-design.sh` は `sdd-design` ピースを `--task "qgrep"` で実行する。
- `run-takt.sh` は `takt` 実行ラッパーであり、設計成果物自体は `.kiro/specs/qgrep/` 配下を正とする。
- 既存アプリ実装がないため、今回の設計は「新規機能（完全発見スコープ）」として扱う。

## 3. 要件分析サマリー
要件は 1〜9 の9グループで構成される。機能的な中核は以下。
- 検索方式切替（正規表現/固定文字列）
- 再帰探索と `.gitignore` 尊重
- パス/拡張子 include/exclude フィルタ
- テキスト出力・JSON出力
- 前後コンテキスト
- 並列検索（`rayon`）と決定的な出力順序
- GNU grep 互換の終了コード
- ユニットテスト・統合テストの同時整備

特に要件 6.3/6.4（整列）と 8.4（マッチあり+エラーでも終了コード2）は、設計上で明示的な責務分離が必要。

## 4. 技術選定の発見
実装は Rust CLI を前提とし、以下の技術要素を設計候補とする。
- CLI引数解析: `clap`
- 正規表現: `regex`
- `.gitignore` を含む探索: `ignore`（または同等機能を満たす探索層）
- 並列実行: `rayon`（要件6.2で必須）
- JSON Lines 出力: `serde` + `serde_json`

外部APIへのネットワーク接続や認証連携は要件に含まれないため、外部システム統合の追加調査は不要。

## 5. 設計リスクと論点
### 5.1 仕様解釈リスク
- パス include/exclude のパターン文法が要件本文で厳密定義されていない。
- バイナリファイル扱い（検索対象に含める/除外する）の規定がない。

### 5.2 振る舞いリスク
- 並列検索時に出力順序が不安定化しやすい（要件6.3/6.4違反リスク）。
- 実行エラーとマッチ有無の同時発生時の終了コード判定（要件8.4）で実装漏れが起きやすい。
- コンテキスト行の重複や境界（先頭/末尾付近）で出力仕様差異が起きやすい。

### 5.3 テストリスク
- `cargo test` でユニットと統合を同時に実行する構成を崩すと要件9.7/9.8を満たせない。
- 並列実行のテストが非決定的になるとCI不安定化を招く。

## 6. 設計への反映方針
- 主要責務を明確化するため、検索実行・整列・出力・終了コード判定を分離する。
- 出力順序は「並列検索の後段で単一の整列責務」に集約し、要件6.3/6.4を担保する。
- エラー情報は検索結果と分離保持し、終了コード判定ポリシーで一元決定する。
- テストは要件トレース可能な粒度で、ユニット（純粋ロジック）と統合（CLI入出力）に分離する。

## 7. 未解決事項
- パスフィルタ文法（glob/regex/前方一致など）の最終確定。
- バイナリファイルの既定扱い。

上記2点は実装開始時に仕様補足が必要だが、現時点の要件を満たす設計文書作成は可能。
