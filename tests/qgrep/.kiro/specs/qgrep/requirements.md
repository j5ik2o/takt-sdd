## 導入
`qgrep` は、開発者が大規模なソースツリーから目的の文字列を素早く発見するためのテキスト検索CLIである。正規表現検索と固定文字列検索を切り替え可能とし、再帰探索、`.gitignore` 尊重、パス/拡張子フィルタ、コンテキスト表示、JSON出力を提供する。

本要件は、`qgrep` の振る舞いをEARS形式で定義し、終了コード互換性とテスト容易性を確保することを目的とする。ここで定義した要件は、ユニットテストと統合テストの受け入れ基準として利用する。

## 要件
### 1 検索方式の選択
**目的:** 開発者として 検索方式を入力内容に応じて切り替える機能 を実現し、意図した一致条件で検索結果を得たい。  
**依存要件:** なし

**受け入れ条件**
- 1.1 ユーザーが検索パターンと検索対象を指定して `qgrep` を実行したとき、`qgrep CLI` は正規表現検索を実行しなければならない。
- 1.2 ユーザーが固定文字列検索オプションを指定したとき、`qgrep CLI` は固定文字列検索を実行しなければならない。
- 1.3 固定文字列検索が有効ならば、`qgrep CLI` は正規表現メタ文字を通常文字として一致判定しなければならない。
- 1.4 不正な正規表現が入力された場合、`qgrep CLI` は終了コード `2` で終了しなければならない。

### 2 再帰検索と `.gitignore` 尊重
**目的:** 開発者として ディレクトリ全体を再帰検索する機能 を実現し、不要ファイルを除外した検索結果を得たい。  
**依存要件:** 1

**受け入れ条件**
- 2.1 ユーザーがディレクトリパスを指定したとき、`qgrep CLI` は配下のファイルを再帰的に探索しなければならない。
- 2.2 ユーザーがファイルパスを指定したとき、`qgrep CLI` は指定されたファイルのみを検索対象にしなければならない。
- 2.3 探索対象ファイルが `.gitignore` 規則に一致する場合、`qgrep CLI` はそのファイルを検索対象から除外しなければならない。
- 2.4 ユーザーが探索起点ディレクトリを指定したとき、`qgrep CLI` はその起点から解決できる `.gitignore` 規則を適用しなければならない。

### 3 パス/拡張子フィルタ
**目的:** 開発者として 検索対象をパスと拡張子で絞り込む機能 を実現し、不要なファイル走査を避けたい。  
**依存要件:** 2

**受け入れ条件**
- 3.1 ユーザーがパス include フィルタを指定したとき、`qgrep CLI` は一致するパスのみを検索対象にしなければならない。
- 3.2 ユーザーがパス exclude フィルタを指定したとき、`qgrep CLI` は一致するパスを検索対象から除外しなければならない。
- 3.3 ユーザーが拡張子 include フィルタを指定したとき、`qgrep CLI` は一致する拡張子のファイルのみを検索対象にしなければならない。
- 3.4 ユーザーが拡張子 exclude フィルタを指定したとき、`qgrep CLI` は一致する拡張子のファイルを検索対象から除外しなければならない。
- 3.5 同一ファイルが include と exclude の両方に一致する場合、`qgrep CLI` はそのファイルを除外しなければならない。

### 4 行番号・ファイル名付きテキスト出力
**目的:** 開発者として 一致箇所を編集可能な形式で出力する機能 を実現し、該当箇所へ即座に移動したい。  
**依存要件:** 1, 2, 3

**受け入れ条件**
- 4.1 一致行が見つかったとき、`qgrep CLI` は `ファイルパス:行番号:行内容` 形式で1行出力しなければならない。
- 4.2 1ファイル内で複数行が一致したとき、`qgrep CLI` は一致行ごとに1行ずつ出力しなければならない。
- 4.3 複数ファイルで一致したとき、`qgrep CLI` は各一致行に対応するファイルパスを出力しなければならない。

### 5 前後コンテキスト表示
**目的:** 開発者として 一致行の前後文脈を確認する機能 を実現し、周辺コードを同時に把握したい。  
**依存要件:** 4

**受け入れ条件**
- 5.1 ユーザーが `-A N` を指定したとき、`qgrep CLI` は一致行の後続 `N` 行を出力しなければならない。
- 5.2 ユーザーが `-B N` を指定したとき、`qgrep CLI` は一致行の先行 `N` 行を出力しなければならない。
- 5.3 ユーザーが `-C N` を指定したとき、`qgrep CLI` は一致行の先行 `N` 行を出力しなければならない。
- 5.4 ユーザーが `-C N` を指定したとき、`qgrep CLI` は一致行の後続 `N` 行を出力しなければならない。
- 5.5 `N` が `0` ならば、`qgrep CLI` は追加コンテキスト行を出力してはならない。
- 5.6 `N` が負数または整数変換不能な値である場合、`qgrep CLI` は終了コード `2` で終了しなければならない。

### 6 並列検索
**目的:** 開発者として 複数ファイルを同時検索する機能 を実現し、探索完了までの待ち時間を減らしたい。  
**依存要件:** 2, 3, 4

**受け入れ条件**
- 6.1 検索対象ファイルが2件以上あるならば、`qgrep CLI` は複数ファイルを同時に検索しなければならない。
- 6.2 並列検索が有効な場合、`qgrep CLI` は `rayon` 実行基盤上で検索タスクを処理しなければならない。
- 6.3 並列検索が有効な場合、`qgrep CLI` は出力行をファイルパス昇順で整列しなければならない。
- 6.4 同一ファイル内に複数一致がある場合、`qgrep CLI` は出力行を行番号昇順で整列しなければならない。

### 7 JSON出力
**目的:** 開発者として 機械可読な検索結果出力 を実現し、他ツールへの連携を行いたい。  
**依存要件:** 4, 5

**受け入れ条件**
- 7.1 ユーザーが JSON 出力オプションを指定したとき、`qgrep CLI` は一致1件ごとに1行のJSONオブジェクトを出力しなければならない。
- 7.2 JSON 出力オプションを指定した場合、`qgrep CLI` は `path` フィールドを出力しなければならない。
- 7.3 JSON 出力オプションを指定した場合、`qgrep CLI` は `line_number` フィールドを出力しなければならない。
- 7.4 JSON 出力オプションを指定した場合、`qgrep CLI` は `line` フィールドを出力しなければならない。
- 7.5 JSON 出力オプションを指定した場合、`qgrep CLI` は `before_context` フィールドを配列で出力しなければならない。
- 7.6 JSON 出力オプションを指定した場合、`qgrep CLI` は `after_context` フィールドを配列で出力しなければならない。
- 7.7 JSON 出力オプションを指定した場合、`qgrep CLI` はプレーンテキスト形式の一致行を出力してはならない。

### 8 GNU grep 互換の終了コード
**目的:** 開発者として 既存スクリプトと互換な終了コード を実現し、自動化処理へ安全に組み込みたい。  
**依存要件:** 1, 2, 3, 4, 5, 6, 7

**受け入れ条件**
- 8.1 一致が1件以上見つかったとき、`qgrep CLI` は終了コード `0` を返さなければならない。
- 8.2 一致が0件で実行エラーが発生していないとき、`qgrep CLI` は終了コード `1` を返さなければならない。
- 8.3 実行エラーが発生したとき、`qgrep CLI` は終了コード `2` を返さなければならない。
- 8.4 一致が1件以上見つかり、実行エラーも発生したとき、`qgrep CLI` は終了コード `2` を返さなければならない。

### 9 プロジェクト初期化とテスト
**目的:** 開発者として 実装と検証の土台を標準手順で整える機能 を実現し、要件を反復検証できる状態を維持したい。  
**依存要件:** 1, 2, 3, 4, 5, 6, 7, 8

**受け入れ条件**
- 9.1 新規実装を開始するとき、`qgrep プロジェクト` は `cargo init` で生成されたCargo構成を持たなければならない。
- 9.2 単体テストを実行するとき、`qgrep プロジェクト` は検索方式選択を検証するユニットテストを含まなければならない。
- 9.3 単体テストを実行するとき、`qgrep プロジェクト` はフィルタ判定を検証するユニットテストを含まなければならない。
- 9.4 統合テストを実行するとき、`qgrep プロジェクト` はCLIテキスト出力を検証する統合テストを含まなければならない。
- 9.5 統合テストを実行するとき、`qgrep プロジェクト` はCLI JSON出力を検証する統合テストを含まなければならない。
- 9.6 統合テストを実行するとき、`qgrep プロジェクト` は終了コードを検証する統合テストを含まなければならない。
- 9.7 `cargo test` を実行したとき、`qgrep プロジェクト` はユニットテストを実行しなければならない。
- 9.8 `cargo test` を実行したとき、`qgrep プロジェクト` は統合テストを実行しなければならない。
