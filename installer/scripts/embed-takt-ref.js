import { execSync } from "node:child_process";
import { writeFileSync, mkdirSync } from "node:fs";
import { resolve, dirname } from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const outDir = resolve(__dirname, "..", "src", "generated");
const outFile = resolve(outDir, "takt-ref.ts");

// Get the commit hash of the references/takt submodule
const repoRoot = resolve(__dirname, "..", "..");
const output = execSync("git submodule status references/takt", {
  cwd: repoRoot,
  encoding: "utf-8",
}).trim();

// Format: " <hash> references/takt (<describe>)" or "-<hash> references/takt" (not initialized)
const match = output.match(/^[- +]?([0-9a-f]+)\s/);
if (!match) {
  console.error(`Failed to parse submodule status: ${output}`);
  process.exit(1);
}

const hash = match[1];

mkdirSync(outDir, { recursive: true });
writeFileSync(
  outFile,
  `// Auto-generated by scripts/embed-takt-ref.js â€” do not edit\nexport const TAKT_REF_HASH = "${hash}";\n`,
);

console.log(`Embedded takt ref: ${hash}`);
